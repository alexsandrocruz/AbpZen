@attribute [Authorize(AbpAuditLoggingPermissions.AuditLogs.Default)]
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.Auditing
@inherits AbpAuditLoggingComponentBase

@* ************************* SEARCH ************************* *@
<Card>
    <CardBody>
        <Fields Horizontal="true">
            <Field ColumnSize="@ColumnSize.Is3.OnWidescreen.Is6.OnMobile">
                <FieldLabel>@L["Date"]</FieldLabel>
                <DatePicker TValue="DateTime?"
                            SelectionMode="DateInputSelectionMode.Range" 
                            DatesChanged="OnTimeChangedAsync"
                            Placeholder="@string.Empty"/>
            </Field>
            <Field ColumnSize="@ColumnSize.Is3.OnWidescreen.Is6.OnMobile">
                <FieldLabel>@L["ChangeType"]</FieldLabel>
                <Select TValue="int" @bind-SelectedValue="EntityChangeValue">
                    <SelectItem Value="@NullEntityChangeValue">-</SelectItem>
                    @foreach (var entityChangeType in GetEntityChangeTypeList())
                    {
                        <SelectItem Value="(int)entityChangeType">@entityChangeType</SelectItem>
                    }
                </Select>
            </Field>
            <Field ColumnSize="@ColumnSize.Is3.OnWidescreen.Is6.OnMobile">
                <FieldLabel>@L["EntityId"]</FieldLabel>
                <TextEdit @bind-Text="@Filter.EntityId" />
            </Field>
            <Field ColumnSize="@ColumnSize.Is3.OnWidescreen.Is6.OnMobile">
                <FieldLabel>@L["EntityTypeFullName"]</FieldLabel>
                <TextEdit @bind-Text="@Filter.EntityTypeFullName" />
            </Field>
            <Field ColumnSize="@ColumnSize.Is2.OnWidescreen.Is12.OnMobile">
                <FieldLabel> </FieldLabel>
                <Button Block="true"
                        Color="@Color.Primary"
                        class="mt-1"
                        Clicked="@SearchEntitiesAsync">
                    <Icon Name="IconName.Search"/>
                </Button>
            </Field>
        </Fields>
    </CardBody>
</Card>

@* ************************* DATA GRID ************************* *@
<AbpExtensibleDataGrid TItem="EntityChangeDto"
                       Data="@EntityChangeList"
                       ReadData="@OnDataGridReadAsync"
                       TotalItems="@TotalCount"
                       ShowPager="true"
                       PageSize="@PageSize"
                       CurrentPage="@CurrentPage"
                       Columns="@EntityChangesTableColumns"
                       Responsive="true">
</AbpExtensibleDataGrid>

@* ************************* DETAIL MODAL ************************* *@
<Modal @ref="@DetailModal" Closing="@ClosingDetailModal">
    <ModalContent Size="@ModalSize.Large" Centered="true">
        <ModalHeader>
            <ModalTitle>
                @if (EntityHistories?.Count > 0)
                {
                    @EntityChangeList[0].EntityTypeFullName <br /> <span style='font-size:small'>("@EntityChangeList[0].EntityId")</span>
                }
            </ModalTitle>
            <CloseButton Clicked="@CloseDetailModalAsync" />
        </ModalHeader>
        <ModalBody>
            @if (EntityHistories != null)
            {
                @foreach (var entityChangeWithUsername in EntityHistories)
                {
                    var entityChangeId = entityChangeWithUsername.EntityChange.Id;
                    var entityChangeType = entityChangeWithUsername.EntityChange.ChangeType;
                    var entityChangeTime = entityChangeWithUsername.EntityChange.ChangeTime;

                    @if (!EntityChangesPanelStatus.ContainsKey(entityChangeId))
                    {
                        EntityChangesPanelStatus.Add(entityChangeId, EntityHistories[0].EntityChange.Id == entityChangeId);
                    }

                    <Accordion>
                        <Collapse Visible="@EntityChangesPanelStatus[entityChangeId]">
                            <CollapseHeader>
                                <Button Color="@Color.Primary"
                                        Block="true"
                                        Clicked="@(() => EntityChangesPanelStatus[entityChangeId] = !EntityChangesPanelStatus[entityChangeId])">
                                    @if (string.IsNullOrEmpty(entityChangeWithUsername.UserName))
                                    {
                                        @string.Format(L["DaysAgoTitle"].Value, L[entityChangeType.ToString()].Value, entityChangeTime);
                                    }
                                    else
                                    {
                                        @string.Format(L["DaysAgoWithUserTitle"].Value, L[entityChangeType.ToString()].Value, entityChangeTime, entityChangeWithUsername.UserName);
                                    }
                                </Button>
                            </CollapseHeader>
                            <CollapseBody>
                                <Table>
                                    <TableHeader>
                                        <TableRow>
                                            <TableHeaderCell>@L["PropertyName"]</TableHeaderCell>
                                            <TableHeaderCell>@L["OriginalValue"]</TableHeaderCell>
                                            <TableHeaderCell>@L["NewValue"]</TableHeaderCell>
                                        </TableRow>
                                    </TableHeader>
                                    <TableBody>
                                        @foreach (var propertyChange in entityChangeWithUsername.EntityChange.PropertyChanges.OrderBy(x => x.PropertyName))
                                        {
                                            <TableRow>
                                                <TableRowCell>@propertyChange.PropertyName</TableRowCell>
                                                <TableRowCell>@propertyChange.OriginalValue</TableRowCell>
                                                @{
                                                    var color = TextColor.Default;
                                                }
                                                @if (entityChangeType != EntityChangeType.Created && (propertyChange.NewValue != propertyChange.OriginalValue))
                                                {
                                                    color = TextColor.Danger;
                                                }
                                                <TableRowCell TextColor="@color">@propertyChange.NewValue</TableRowCell>

                                            </TableRow>
                                        }
                                    </TableBody>
                                </Table>
                            </CollapseBody>
                        </Collapse>
                    </Accordion>
                }
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="@Color.Primary" Clicked="@CloseDetailModalAsync">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>
