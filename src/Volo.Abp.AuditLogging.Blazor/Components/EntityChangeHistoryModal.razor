@using Microsoft.Extensions.Localization
@using Volo.Abp.Auditing
@using Volo.Abp.AuditLogging.Localization
@inject IStringLocalizer<AuditLoggingResource> L

<Modal @ref="@_modal" Closing="@ClosingModal">
    <ModalContent Size="@ModalSize.Large" Centered="true">
        <ModalHeader>
            <ModalTitle>
                @if (EntityHistories?.Count > 0)
                {
                    @EntityHistories[0].EntityChange.EntityTypeFullName <br /> <span style='font-size:small'>("@EntityHistories[0].EntityChange.EntityId")</span>
                }
                else
                {
                    @EntityTypeFullName <br /> <span style='font-size:small'>("@EntityId")</span>
                }

            </ModalTitle>
            <CloseButton Clicked="@CloseModal" />
        </ModalHeader>
        <ModalBody>
            @if (EntityHistories != null)
            {
                @foreach (var entityChangeWithUsername in EntityHistories)
                {
                    var entityChangeId = entityChangeWithUsername.EntityChange.Id;
                    var entityChangeType = entityChangeWithUsername.EntityChange.ChangeType;
                    var entityChangeTime = entityChangeWithUsername.EntityChange.ChangeTime;

                    @if (!EntityChangesPanelStatus.ContainsKey(entityChangeId))
                    {
                        EntityChangesPanelStatus.Add(entityChangeId, EntityHistories[0].EntityChange.Id == entityChangeId);
                    }

                    <Accordion>
                        <Collapse Visible="@EntityChangesPanelStatus[entityChangeId]">
                            <CollapseHeader>
                                <Button Color="@Color.Primary"
                                        Block="true"
                                        Clicked="@(() => EntityChangesPanelStatus[entityChangeId] = !EntityChangesPanelStatus[entityChangeId])">
                                    @if (string.IsNullOrEmpty(entityChangeWithUsername.UserName))
                                    {
                                        @string.Format(L["DaysAgoTitle"].Value, L[entityChangeType.ToString()].Value, entityChangeTime);
                                    }
                                    else
                                    {
                                        @string.Format(L["DaysAgoWithUserTitle"].Value, L[entityChangeType.ToString()].Value, entityChangeTime, entityChangeWithUsername.UserName);
                                    }
                                </Button>
                            </CollapseHeader>
                            <CollapseBody>
                                <Table>
                                    <TableHeader>
                                        <TableRow>
                                            <TableHeaderCell>@L["PropertyName"]</TableHeaderCell>
                                            <TableHeaderCell>@L["OriginalValue"]</TableHeaderCell>
                                            <TableHeaderCell>@L["NewValue"]</TableHeaderCell>
                                        </TableRow>
                                    </TableHeader>
                                    <TableBody>
                                        @foreach (var propertyChange in entityChangeWithUsername.EntityChange.PropertyChanges.OrderBy(x => x.PropertyName))
                                        {
                                            <TableRow>
                                                <TableRowCell>@propertyChange.PropertyName</TableRowCell>
                                                <TableRowCell>@GetValueInProperFormat(propertyChange.OriginalValue)</TableRowCell>
                                                @{
                                                    var color = TextColor.Default;
                                                }
                                                @if (entityChangeType != EntityChangeType.Created && (propertyChange.NewValue != propertyChange.OriginalValue))
                                                {
                                                    color = TextColor.Danger;
                                                }
                                                <TableRowCell TextColor="@color">@GetValueInProperFormat(propertyChange.NewValue)</TableRowCell>

                                            </TableRow>
                                        }
                                    </TableBody>
                                </Table>
                            </CollapseBody>
                        </Collapse>
                    </Accordion>
                }
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="@Color.Secondary" Clicked="@CloseModal">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>
