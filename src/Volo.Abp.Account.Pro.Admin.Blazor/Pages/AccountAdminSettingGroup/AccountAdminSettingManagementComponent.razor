@using Microsoft.Extensions.Localization
@using Volo.Abp.Identity.Localization
@using Volo.Abp.BlazoriseUI.Components
@using Volo.Abp.AspNetCore.Components
@inherits AbpComponentBase
@inject AbpBlazorMessageLocalizerHelper<IdentityResource> LH
@inject IStringLocalizerFactory LocalizerFactory

@if (Settings?.AccountSettings != null)
{
    <Row>
        <Column>
            <Tabs @bind-SelectedTab="@SelectedTab">
                <Items>
                    <Tab Name="AccountSettingsGeneral">
                        @L["AccountSettingsGeneral"]
                    </Tab>
                    @if (Settings.AccountTwoFactorSettings != null)
                    {
                        <Tab Name="AccountTwoFactorSettings">
                            @L["AccountSettingsTwoFactor"]
                        </Tab>
                    }
                    @if (ShouldShowCaptchaSettings())
                    {
                        <Tab Name="AccountCaptchaSettings">
                            @L["Captcha"]
                        </Tab>
                    }
                    @if (ShouldShowExternalProviderSettings())
                    {
                        <Tab Name="AccountExternalProviderSettings">
                            @L["AccountExternalProviderSettings"]
                        </Tab>
                    }
                </Items>
                <Content>
                    <TabPanel Name="AccountSettingsGeneral">
                        <Form id="AccountSettingEditForm">
                            <Field>
                                <Check TValue="bool" @bind-Checked="@Settings.AccountSettings.IsSelfRegistrationEnabled">
                                    @L["DisplayName:IsSelfRegistrationEnabled"]
                                </Check>
                            </Field>
                            <Field>
                                <Check TValue="bool" @bind-Checked="@Settings.AccountSettings.EnableLocalLogin">
                                    @L["DisplayName:EnableLocalLogin"]
                                    <br /><FieldHelp>@L["Description:EnableLocalLogin"]</FieldHelp>
                                </Check>
                            </Field>
                            <Field>
                                <Check TValue="bool" @bind-Checked="@Settings.AccountSettings.PreventEmailEnumeration">
                                    @L["DisplayName:PreventEmailEnumeration"]
                                    <br /><FieldHelp>@L["Description:PreventEmailEnumeration"]</FieldHelp>
                                </Check>
                            </Field>
                            <hr class="my-4" />
                            <Field>
                                <SubmitButton Form="AccountSettingEditForm" Clicked="@UpdateAccountSettings" />
                            </Field>
                        </Form>
                    </TabPanel>
                    @if (Settings.AccountTwoFactorSettings != null)
                    {
                        <TabPanel Name="AccountTwoFactorSettings">
                            <Form id="AccountTwoFactorSettingsEditForm">
                                <Field>
                                    <FieldLabel>@IdentityLocalizer["DisplayName:Abp.Identity.TwoFactorBehaviour"]</FieldLabel>
                                    <Select TValue="Identity.Features.IdentityProTwoFactorBehaviour" @bind-SelectedValue="@Settings.AccountTwoFactorSettings.TwoFactorBehaviour">
                                        <SelectItem Value="@Identity.Features.IdentityProTwoFactorBehaviour.Disabled">Disabled</SelectItem>
                                        <SelectItem Value="@Identity.Features.IdentityProTwoFactorBehaviour.Optional">Optional</SelectItem>
                                        <SelectItem Value="@Identity.Features.IdentityProTwoFactorBehaviour.Forced">Forced</SelectItem>
                                    </Select>
                                </Field>
                                <Field>
                                    <Check TValue="bool" @bind-Checked="@Settings.AccountTwoFactorSettings.UsersCanChange">
                                        @IdentityLocalizer["DisplayName:Abp.Identity.UsersCanChange"]
                                    </Check>
                                </Field>
                                <Field>
                                    <Check TValue="bool" @bind-Checked="@Settings.AccountTwoFactorSettings.IsRememberBrowserEnabled">
                                        @L["DisplayName:IsRememberBrowserEnabled"]
                                    </Check>
                                </Field>

                                <hr class="my-4" />

                                <Field>
                                    <SubmitButton Form="AccountTwoFactorSettingsEditForm" Clicked="@UpdateTwoFactorSettings" />
                                </Field>
                            </Form>
                        </TabPanel>
                    }
                    @if (ShouldShowCaptchaSettings())
                    {
                        <TabPanel Name="AccountCaptchaSettings">
                            <Form id="AccountCaptchaSettingsEditForm">
                                <div class="row g-0 mb-3">
                                    <div class="col-2">
                                        <img src="_content/Volo.Abp.Account.Pro.Admin.Blazor/images/recaptcha.png" class="img-fluid" style="max-width: 85%;">
                                    </div>
                                    <div class="col-8 ms-2 ">
                                        <h2>@L["GoogleCaptcha"]</h2>
                                        <p class="text-muted ">@L["GoogleCaptchaDescription"]</p>
                                    </div>
                                </div>
                                <Validations @ref="@AccountCaptchaSettingsValidations" Model="@Settings.AccountRecaptchaSettings" ValidateOnLoad="false">
                                    @if (!CurrentTenant.IsAvailable)
                                    {
                                        <Validation MessageLocalizer="@LH.Localize">
                                            <Field>
                                                <FieldLabel>@L["DisplayName:VerificationUrl"]</FieldLabel>
                                                <TextEdit @bind-Text="@Settings.AccountRecaptchaSettings.VerifyBaseUrl">
                                                    <ChildContent>
                                                        <FieldHelp>@L["Description:VerificationUrl"]</FieldHelp>
                                                    </ChildContent>
                                                    <Feedback>
                                                        <ValidationError/>
                                                    </Feedback>
                                                </TextEdit>
                                            </Field>
                                        </Validation>
                                    }
                                    <Validation MessageLocalizer="@LH.Localize">
                                        <Field>
                                            <FieldLabel>@L["DisplayName:Version"]</FieldLabel>
                                            <NumericEdit TValue="int" Min="2" Max="3" Step="1" @bind-Value="@Settings.AccountRecaptchaSettings.Version">
                                                <ChildContent>
                                                    <FieldHelp>@L["Description:Version"]</FieldHelp>
                                                </ChildContent>
                                                <Feedback>
                                                    <ValidationError/>
                                                </Feedback>
                                            </NumericEdit>
                                        </Field>
                                    </Validation>
                                    <Validation MessageLocalizer="@LH.Localize">
                                        <Field>
                                            <FieldLabel>@L["DisplayName:SiteKey"]</FieldLabel>
                                            <TextEdit @bind-Text="@Settings.AccountRecaptchaSettings.SiteKey">
                                                <ChildContent>
                                                    <FieldHelp>@L["Description:SiteKey"]</FieldHelp>
                                                </ChildContent>
                                                <Feedback>
                                                    <ValidationError/>
                                                </Feedback>
                                            </TextEdit>
                                        </Field>
                                    </Validation>
                                    <Validation MessageLocalizer="@LH.Localize">
                                        <Field>
                                            <FieldLabel>@L["DisplayName:SiteSecret"]</FieldLabel>
                                            <TextEdit @bind-Text="@Settings.AccountRecaptchaSettings.SiteSecret">
                                                <ChildContent>
                                                    <FieldHelp>@L["Description:SiteSecret"]</FieldHelp>
                                                </ChildContent>
                                                <Feedback>
                                                    <ValidationError/>
                                                </Feedback>
                                            </TextEdit>
                                        </Field>
                                    </Validation>
                                    <Validation MessageLocalizer="@LH.Localize">
                                        <Field>
                                            <FieldLabel>@L["DisplayName:Score"]</FieldLabel>
                                            <NumericEdit TValue="double" Min="0" Max="1" Step=".1m" @bind-Value="@Settings.AccountRecaptchaSettings.Score">
                                                <ChildContent>
                                                    <FieldHelp>@L["Description:Score"]</FieldHelp>
                                                </ChildContent>
                                                <Feedback>
                                                    <ValidationError/>
                                                </Feedback>
                                            </NumericEdit>
                                        </Field>
                                    </Validation>

                                    @if (!CurrentTenant.IsAvailable)
                                    {
                                        <div class="row">
                                            <div class="col-md-6">
                                                <Field>
                                                    <Check TValue="bool" @bind-Checked="@Settings.AccountRecaptchaSettings.UseCaptchaOnLogin">
                                                        @L["DisplayName:UseCaptchaOnLogin"]
                                                    </Check>
                                                </Field>
                                            </div>
                                            <div class="col-md-6">
                                                <Field>
                                                    <Check TValue="bool" @bind-Checked="@Settings.AccountRecaptchaSettings.UseCaptchaOnRegistration">
                                                        @L["DisplayName:UseCaptchaOnRegistration"]
                                                    </Check>
                                                </Field>
                                            </div>
                                        </div>
                                    }

                                    <hr class="my-4"/>

                                    <Field>
                                        <SubmitButton Form="AccountCaptchaSettingsEditForm" Clicked="@UpdateCaptchaSettings"/>
                                    </Field>
                                </Validations>
                            </Form>
                        </TabPanel>
                    }
                    @if (ShouldShowExternalProviderSettings())
                    {
                        <TabPanel Name="AccountExternalProviderSettings">
                            <Form id="AccountExternalProviderSettingsEditForm">
                                @{
                                    var defaultLocalizer = LocalizerFactory.CreateDefaultOrNull();
                                }

                                <h4>@L["SocialAccountSecurity"].Value</h4>
                                <Field>
                                    <Check TValue="bool" @bind-Checked="@Settings.AccountExternalProviderSettings.VerifyPasswordDuringExternalLogin">
                                        @L["DisplayName:VerifyPasswordDuringExternalLogin"]
                                        <br /><FieldHelp>@L["Description:VerifyPasswordDuringExternalLogin"]</FieldHelp>
                                    </Check>
                                </Field>

                                @if (CurrentTenant.IsAvailable)
                                {
                                    foreach (var provider in Settings.AccountExternalProviderSettings.ExternalProviders.Where(setting => setting.Enabled))
                                    {
                                        <Heading Size="HeadingSize.Is4">
                                            @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}", provider.Name)
                                        </Heading>

                                        <Field>
                                            <Check TValue="bool"
                                   Checked="@ExternalProviderUseHostSettings[provider.Name]"
                                   CheckedChanged="(b) => OnExternalProviderUseHostSettingsChanged(provider, b)">
                                                @L["ExternalProviderUseHostSettings"]
                                            </Check>
                                        </Field>

                                        if (!ExternalProviderUseHostSettings[provider.Name])
                                        {
                                            foreach (var property in provider.Properties)
                                            {
                                                <Field>
                                                    <FieldLabel>
                                                        @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}:{property.Name}", property.Name)
                                                    </FieldLabel>
                                                    <TextEdit @bind-Text="@property.Value" />
                                                </Field>
                                            }

                                            foreach (var property in provider.SecretProperties)
                                            {
                                                <Field>
                                                    <FieldLabel>
                                                        @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}:{property.Name}", property.Name)
                                                    </FieldLabel>
                                                    <TextEdit Role="TextRole.Password" @bind-Text="@property.Value" />
                                                </Field>
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var provider in Settings.AccountExternalProviderSettings.ExternalProviders)
                                    {
                                        <Heading Size="HeadingSize.Is4">
                                            @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}", provider.Name)
                                        </Heading>

                                        <Field>
                                            <Check TValue="bool" @bind-Checked="@provider.Enabled">
                                                @L["ExternalProviderEnabled"]
                                            </Check>
                                        </Field>

                                        if (provider.Enabled)
                                        {
                                            foreach (var property in provider.Properties)
                                            {
                                                <Field>
                                                    <FieldLabel>
                                                        @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}:{property.Name}", property.Name)
                                                    </FieldLabel>
                                                    <TextEdit @bind-Text="@property.Value" />
                                                </Field>
                                            }

                                            foreach (var property in provider.SecretProperties)
                                            {
                                                <Field>
                                                    <FieldLabel>
                                                        @ExternalLoginProviderLocalizationHelper.Localize(defaultLocalizer, $"ExternalProvider:{provider.Name}:{property.Name}", property.Name)
                                                    </FieldLabel>
                                                    <TextEdit Role="TextRole.Password" @bind-Text="@property.Value" />
                                                </Field>
                                            }
                                        }
                                    }
                                }

                                <hr class="my-4" />

                                <Field>
                                    <SubmitButton Form="AccountExternalProviderSettingsEditForm" Clicked="@UpdateExternalProviderSettings" />
                                </Field>
                            </Form>
                        </TabPanel>
                    }
                </Content>
            </Tabs>
        </Column>
    </Row>
}
