@page
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@using Volo.Abp.Data
@using Volo.Abp.Localization
@using Volo.Abp.ObjectExtending
@using Volo.Abp.OpenIddict.Localization
@using Volo.Abp.OpenIddict.Pro.Web.Pages.OpenIddict.Applications
@model Volo.Abp.OpenIddict.Pro.Web.Pages.OpenIddict.Applications.CreateModal
@inject IHtmlLocalizer<AbpOpenIddictResource> L
@inject IStringLocalizerFactory StringLocalizerFactory

@{
    Layout = null;
}

<form asp-page="/OpenIddict/Applications/CreateModal">
    <abp-modal size="Large">
        <abp-modal-header title="@L["NewApplication"].Value"></abp-modal-header>
        <abp-modal-body>
            <abp-row>
                <abp-column size="_6">
                    <abp-select asp-for="Application.ApplicationType" asp-items="Model.ApplicationTypes" />
                    <abp-input asp-for="Application.ClientId"/>
                    <abp-input asp-for="Application.DisplayName"/>
                    <abp-input asp-for="Application.ClientUri"/>
                    <abp-input asp-for="Application.LogoUri"/>
                    <abp-select asp-for="Application.ClientType" asp-items="Model.Types"/>
                    <abp-input asp-for="Application.ClientSecret"/>
                </abp-column>
                <abp-column size="_6">
                    <abp-input asp-for="Application.AllowAuthorizationCodeFlow"/>
                    <abp-input asp-for="Application.AllowImplicitFlow"/>
                    <abp-input asp-for="Application.AllowHybridFlow"/>
                    <abp-input asp-for="Application.AllowPasswordFlow"/>
                    <abp-input asp-for="Application.AllowClientCredentialsFlow"/>
                    <abp-input asp-for="Application.AllowRefreshTokenFlow" disabled/>
                    <abp-input asp-for="Application.AllowDeviceEndpoint"/>
                    <abp-input wrap="off" asp-for="Application.ExtensionGrantTypes"></abp-input>

                    <div class="HideInputs" style="display: none;">
                        <abp-input wrap="off" asp-for="Application.RedirectUris"></abp-input>
                        <abp-input asp-for="Application.AllowLogoutEndpoint"></abp-input>
                        <div class="PostLogoutRedirectUrisInput" style="display: none;">
                            <abp-input wrap="off" asp-for="Application.PostLogoutRedirectUris"></abp-input>
                        </div>
                        <abp-select asp-for="Application.ConsentType" asp-items="Model.ConsentTypes"/>
                    </div>

                    <h5>@L["Scopes"]</h5>
                    @if (Model.Scopes.Any())
                    {
                        @foreach (var scope in Model.Scopes)
                        {
                            <div class="mb-2 custom-checkbox custom-control form-check">
                                <input type="checkbox" data-val="true" id="@("Application_" + scope.Name)" name="Application.Scopes" value="@scope.Name" class="form-check-input">
                                <label class="form-check-label" for="@("Application_" + scope.Name)">@scope.Name</label>
                            </div>
                        }
                    }
                    else
                    {
                        @L["NoAvailableScopes"]
                    }


                    @foreach (var propertyInfo in ObjectExtensionManager.Instance.GetProperties<ApplicationCreateModalView>())
                    {
                        if (!propertyInfo.Name.EndsWith("_Text"))
                        {
                            if (propertyInfo.Type.IsEnum || !propertyInfo.Lookup.Url.IsNullOrEmpty())
                            {
                                if (propertyInfo.Type.IsEnum)
                                {
                                    Model.Application.ExtraProperties.ToEnum(propertyInfo.Name, propertyInfo.Type);
                                }
                                <abp-select asp-for="Application.ExtraProperties[propertyInfo.Name]"
                                            label="@propertyInfo.GetLocalizedDisplayName(StringLocalizerFactory)"
                                            autocomplete-api-url="@propertyInfo.Lookup.Url"
                                            autocomplete-selected-item-name="@Model.Application.GetProperty(propertyInfo.Name + "_Text")"
                                            autocomplete-selected-item-value="@Model.Application.GetProperty(propertyInfo.Name)"
                                            autocomplete-filter-param-name="@propertyInfo.Lookup.FilterParamName"
                                            autocomplete-items-property-name="@propertyInfo.Lookup.ResultListPropertyName"
                                            autocomplete-display-property-name="@propertyInfo.Lookup.DisplayPropertyName"
                                            autocomplete-value-property-name="@propertyInfo.Lookup.ValuePropertyName"></abp-select>
                            }
                            else
                            {
                                <abp-input type="@propertyInfo.GetInputType()"
                                           asp-for="Application.ExtraProperties[propertyInfo.Name]"
                                           label="@propertyInfo.GetLocalizedDisplayName(StringLocalizerFactory)"
                                           asp-format="@propertyInfo.GetInputFormatOrNull()"
                                           value="@propertyInfo.GetInputValueOrNull(Model.Application.GetProperty(propertyInfo.Name))"/>
                            }
                        }
                    }
                </abp-column>
            </abp-row>
        </abp-modal-body>
        <abp-modal-footer buttons="@(AbpModalButtons.Cancel|AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>
