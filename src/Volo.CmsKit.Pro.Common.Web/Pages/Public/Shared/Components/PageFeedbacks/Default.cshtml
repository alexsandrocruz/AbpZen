@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Alert
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Blockquote
@using Volo.Abp.SettingManagement
@using Volo.CmsKit
@using Volo.CmsKit.Localization
@using Volo.CmsKit.PageFeedbacks
@inject IHtmlLocalizer<CmsKitResource> L
@inject ISettingManager SettingManager
@model Volo.CmsKit.Pro.Web.Pages.Public.Shared.Components.PageFeedbacks.PageFeedbackViewDto

@{
    var requireCommentsForNegativeFeedback = await SettingManager.GetOrNullForCurrentTenantAsync(CmsKitProSettingNames.PageFeedback.RequireCommentsForNegativeFeedback);
    var isModal = ViewBag.PageFeedbackModalId != null;
}
<form id="page-feedback-form" novalidate="" data-entity-id="@Model.EntityId" data-entity-type="@Model.EntityType" data-require-comments-for-negative-feedback="@requireCommentsForNegativeFeedback">
                
    @if (isModal)
    {
        RenderFormBody();
    }
    else
    {
        <div class="card">
            <div class="card-body">
                @{
                    RenderFormBody();
                }
            </div>
        </div>
    }
</form>

<div id="page-feedback-thank-you" class="d-none card mb-0">
    <div class="card-body">
        <h3 class="mb-3">@GetOrDefault(Model.ThankYouMessageTitle, L["PageFeedback:ThankYouTitle"])</h3>
        <p class="mb-0">@GetOrDefault(Model.ThankYouMessageDescription, L["PageFeedback:ThankYouDescription"])</p>
    </div>
</div>

@functions
{
    LocalizedHtmlString GetOrDefault(string value, LocalizedHtmlString defaultValue)
    {
        return string.IsNullOrWhiteSpace(value) ? defaultValue : new LocalizedHtmlString(value, value);
    }

    void GetYesButton()
    {
        <button class="btn btn-feedback btn-outline-dark flex-grow-1 flex-md-grow-0" id="page-feedback-yes-btn" type="button">
            <i class="fa fa-thumbs-up me-2"></i>
            <span class="fw-bold">@GetOrDefault(Model.YesButtonText, L["Yes"])</span><span>, @GetOrDefault(Model.VeryHelpfulText, L["PageFeedback:VeryHelpful"])</span>
        </button>
    }

    void GetNoButton()
    {
        <button class="btn btn-feedback btn-outline-dark flex-grow-1 flex-md-grow-0" id="page-feedback-no-btn" type="button">
            <i class="fa fa-thumbs-down me-2"></i>
            <span class="fw-bold">@GetOrDefault(Model.NoButtonText, L["No"])</span><span>, @GetOrDefault(Model.NeedsImprovementText, L["PageFeedback:NeedsImprovement"])</span>
        </button>
    }

    void RenderFormBody()
    {
        <div class="mb-3">
            @if (Model.HeaderVisible)
            {
                <h3 class="mb-3">@GetOrDefault(Model.HeaderText, L["PageFeedback:Header"])</h3>
            }
            <div class="d-flex flex-wrap gap-3 align-items-center justify-content-start mb-2">
                @if (Model.ReverseButtons)
                {
                    GetNoButton();
                    GetYesButton();
                }
                else
                {
                    GetYesButton();
                    GetNoButton();
                }
            </div> 
            @* validation error *@
            <div class="text-danger d-none" id="page-feedback-validation-error">
                <span>@L["PageFeedbackValidationError"]</span>
            </div> 
        </div>
                
        <div class="d-flex flex-wrap">   
            <div>   
                @* note required *@
                <p class="d-none lead text-start mb-0" id="page-feedback-user-note-required-validation">
                    @L["PageFeedbackRequireUserNoteForNegativeFeedbackValidationError"]
                </p>     
                @* validation error *@
                <p class="text-danger d-none m-0 flex-column" id="page-feedback-user-note-validation">
                    @L["PageFeedbackRequireUserNoteValidationError"]
                </p>   
            </div>   

            <div class="d-flex flex-wrap gap-3 w-100 mt-2">   
                <textarea class="form-control textarea-feedback p-3" rows="3" id="user-feedback" maxlength="@PageFeedbackConst.MaxUserNoteLength" placeholder="@GetOrDefault(Model.UserNotePlaceholder, L["PageFeedbackInputPlaceholder"])"></textarea>
                             
                <button type="submit" id="page-feedback-submit-btn" class="btn btn-info text-nowrap ms-auto flex-grow-1 flex-md-grow-0"> 
                    <i class="fa-regular fa-circle-up me-1" aria-hidden="true"></i>
                    <span>@GetOrDefault(Model.SubmitButtonText, L["Submit"]) Your Feedback</span>
                </button>   
            </div>   
        </div>
                
        <input id="is-useful" class="d-none"/>
    }
}